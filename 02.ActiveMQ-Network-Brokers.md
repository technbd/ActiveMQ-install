## ActiveMQ Network of Brokers:

To Network of Brokers (federation / scaling) — which is another way ActiveMQ achieves high availability and load distribution **without shared disks**.


_A Network of Brokers (NoB) connects two or more independent brokers so that:_
- They can forward messages between each other.
- Consumers on one broker can receive messages produced on another.
- Each broker has its own storage, no shared disk.
- Useful for geo-distributed or large-scale systems.



### Architecture Overview (Network of Brokers):

| Broker      | Hostname | IP             | Role            |
| ----------- | -------- | -------------- | --------------- |
| **broker1** | broker1  | 192.168.10.191 | ActiveMQ node 1 |
| **broker2** | broker2  | 192.168.10.192 | ActiveMQ node 2 |
| **broker3** | broker3  | 192.168.10.193 | ActiveMQ node 3 |


_Each broker:_
- Runs independently (own storage).
- Listens on default ports:
    - 61616 → JMS (application connections)
    - 8161 → Admin Console
- Communicates with other brokers using network connectors over TCP.



### Configuration: Network of Brokers (ActiveMQ 5.x):


#### On `broker1`:

_Edit Jetty file:_
```xml

vim conf/jetty.xml


<bean id="jettyPort" class="org.apache.activemq.web.WebConsolePort" init-method="start">
             <!-- the default port number for the web console -->
        <property name="host" value="0.0.0.0"/>
        <property name="port" value="8161"/>
    </bean>
```



_Edit the main configuration file:_
```xml

vim conf/activemq.xml


<broker xmlns="http://activemq.apache.org/schema/core" brokerName="broker1" dataDirectory="${activemq.data}">


<!-- Optional: web admin console (default 8161) -->
        <managementContext>
            <managementContext createConnector="false"/>
        </managementContext>


<!-- Shared KahaDB Store -->
        <persistenceAdapter>
           <kahaDB directory="${activemq.data}/kahadb"/>
        </persistenceAdapter>


<!-- Network Connector to other brokers -->
    <networkConnectors>
        <networkConnector name="to-broker2" uri="static:(tcp://192.168.10.192:61616)" duplex="true"/>
        <networkConnector name="to-broker3" uri="static:(tcp://192.168.10.193:61616)" duplex="true"/>
    </networkConnectors>


<!-- Network connectors (clients connect here) -->
        <transportConnectors>
            <!-- DOS protection, limit concurrent connections to 1000 and frame size to 100MB -->
            <transportConnector name="openwire" uri="tcp://0.0.0.0:61616?maximumConnections=1000&amp;wireFormat.maxFrameSize=104857600"/>
            <transportConnector name="amqp" uri="amqp://0.0.0.0:5672?maximumConnections=1000&amp;wireFormat.maxFrameSize=104857600"/>
            <transportConnector name="stomp" uri="stomp://0.0.0.0:61613?maximumConnections=1000&amp;wireFormat.maxFrameSize=104857600"/>
            <transportConnector name="mqtt" uri="mqtt://0.0.0.0:1883?maximumConnections=1000&amp;wireFormat.maxFrameSize=104857600"/>
            <transportConnector name="ws" uri="ws://0.0.0.0:61614?maximumConnections=1000&amp;wireFormat.maxFrameSize=104857600"/>
        </transportConnectors>
    
</broker>
```



```
systemctl restart activemq
```




#### On `broker2`:

_Edit Jetty file:_
```xml

vim conf/jetty.xml


<bean id="jettyPort" class="org.apache.activemq.web.WebConsolePort" init-method="start">
             <!-- the default port number for the web console -->
        <property name="host" value="0.0.0.0"/>
        <property name="port" value="8161"/>
    </bean>
```


_Edit the main configuration file:_
```xml

vim conf/activemq.xml


<broker xmlns="http://activemq.apache.org/schema/core" brokerName="broker2" dataDirectory="${activemq.data}">


<!-- Optional: web admin console (default 8161) -->
        <managementContext>
            <managementContext createConnector="false"/>
        </managementContext>


<!-- Shared KahaDB Store -->
        <persistenceAdapter>
           <kahaDB directory="${activemq.data}/kahadb"/>
        </persistenceAdapter>


<!-- Network Connector to other brokers -->
    <networkConnectors>
        <networkConnector name="to-broker1" uri="static:(tcp://192.168.10.191:61616)" duplex="true"/>
        <networkConnector name="to-broker3" uri="static:(tcp://192.168.10.193:61616)" duplex="true"/>
    </networkConnectors>


<!-- Network connectors (clients connect here) -->
        <transportConnectors>
            <!-- DOS protection, limit concurrent connections to 1000 and frame size to 100MB -->
            <transportConnector name="openwire" uri="tcp://0.0.0.0:61616?maximumConnections=1000&amp;wireFormat.maxFrameSize=104857600"/>
            <transportConnector name="amqp" uri="amqp://0.0.0.0:5672?maximumConnections=1000&amp;wireFormat.maxFrameSize=104857600"/>
            <transportConnector name="stomp" uri="stomp://0.0.0.0:61613?maximumConnections=1000&amp;wireFormat.maxFrameSize=104857600"/>
            <transportConnector name="mqtt" uri="mqtt://0.0.0.0:1883?maximumConnections=1000&amp;wireFormat.maxFrameSize=104857600"/>
            <transportConnector name="ws" uri="ws://0.0.0.0:61614?maximumConnections=1000&amp;wireFormat.maxFrameSize=104857600"/>
        </transportConnectors>
    
</broker>
```


```
systemctl restart activemq
```



#### On `broker3`:

_Edit Jetty file:_
```xml

vim conf/jetty.xml


<bean id="jettyPort" class="org.apache.activemq.web.WebConsolePort" init-method="start">
             <!-- the default port number for the web console -->
        <property name="host" value="0.0.0.0"/>
        <property name="port" value="8161"/>
    </bean>
```


_Edit the main configuration file:_
```xml

vim conf/activemq.xml


<broker xmlns="http://activemq.apache.org/schema/core" brokerName="broker3" dataDirectory="${activemq.data}">


<!-- Optional: web admin console (default 8161) -->
        <managementContext>
            <managementContext createConnector="false"/>
        </managementContext>


<!-- Shared KahaDB Store -->
        <persistenceAdapter>
           <kahaDB directory="${activemq.data}/kahadb"/>
        </persistenceAdapter>


<!-- Network Connector to other brokers -->
    <networkConnectors>
        <networkConnector name="to-broker1" uri="static:(tcp://192.168.10.191:61616)" duplex="true"/>
        <networkConnector name="to-broker2" uri="static:(tcp://192.168.10.192:61616)" duplex="true"/>
    </networkConnectors>


<!-- Network connectors (clients connect here) -->
        <transportConnectors>
            <!-- DOS protection, limit concurrent connections to 1000 and frame size to 100MB -->
            <transportConnector name="openwire" uri="tcp://0.0.0.0:61616?maximumConnections=1000&amp;wireFormat.maxFrameSize=104857600"/>
            <transportConnector name="amqp" uri="amqp://0.0.0.0:5672?maximumConnections=1000&amp;wireFormat.maxFrameSize=104857600"/>
            <transportConnector name="stomp" uri="stomp://0.0.0.0:61613?maximumConnections=1000&amp;wireFormat.maxFrameSize=104857600"/>
            <transportConnector name="mqtt" uri="mqtt://0.0.0.0:1883?maximumConnections=1000&amp;wireFormat.maxFrameSize=104857600"/>
            <transportConnector name="ws" uri="ws://0.0.0.0:61614?maximumConnections=1000&amp;wireFormat.maxFrameSize=104857600"/>
        </transportConnectors>
    
</broker>
```



```
systemctl restart activemq
```




### Testing: 

Produce on broker1:
```
./bin/activemq producer --brokerUrl tcp://192.168.10.191:61616 --destination queue://test.queue --messageCount 10
```



Consume on broker3:
```
./bin/activemq consumer --brokerUrl tcp://192.168.10.193:61616 --destination queue://test.queue
```




### Load Balancer for Clients (Optional): 

Here’s a complete **HAProxy** configuration for a 3-node ActiveMQ Network of Brokers, including **frontend** and **backend** sections for both client connections (61616). 

```
frontend activemq_front
    bind *:61616
    mode tcp
    option tcp-check

    default_backend activemq_back

backend activemq_back
    mode tcp
    balance roundrobin
    option tcp-check

    server broker1 192.168.10.191:61616 check inter 3s fall 3 rise 2
    server broker2 192.168.10.192:61616 check inter 3s fall 3 rise 2
    server broker3 192.168.10.193:61616 check inter 3s fall 3 rise 2
```



### ActiveMQ Admin Console (HTTP, port 8161 → HAProxy 80):

```
frontend activemq_console
    bind *:80
    mode http
    default_backend activemq_console_back

backend activemq_console_back
    mode http
    balance roundrobin

    server broker1 192.168.10.191:8161 check inter 3s fall 3 rise 2
    server broker2 192.168.10.192:8161 check inter 3s fall 3 rise 2
    server broker3 192.168.10.193:8161 check inter 3s fall 3 rise 2
```






















